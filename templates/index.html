<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercedes Data Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #00548c;
        }
        .connection-panel {
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .file-explorer {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: white;
            height: 500px;
            overflow: auto;
        }
        .file-explorer .folder {
            cursor: pointer;
            color: #00548c;
        }
        .file-explorer .file {
            color: #333;
        }
        .file-explorer .table td, .file-explorer .table th {
            vertical-align: middle;
        }
        .breadcrumb-item a {
            color: #00548c;
            text-decoration: none;
        }
        .breadcrumb-item.active {
            color: #495057;
        }
        .btn-primary {
            background-color: #00548c;
            border-color: #00548c;
        }
        .btn-primary:hover, .btn-primary:focus {
            background-color: #003e69;
            border-color: #003e69;
        }
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }
        .weaviate-collection {
            cursor: pointer;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            background-color: #f5f5f5;
        }
        .weaviate-collection:hover {
            background-color: #e9ecef;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00548c;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-4">
            <div class="d-flex align-items-center justify-content-between">
                <h1 class="mb-0">Mercedes Data Management</h1>
            </div>
        </header>

        <!-- Alert container for notifications -->
        <div class="alert-container" id="alertContainer"></div>

        <!-- Main Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="s3-tab" data-bs-toggle="tab" data-bs-target="#s3-content" type="button">
                    <i class="bi bi-hdd-rack"></i> S3 Storage
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="weaviate-tab" data-bs-toggle="tab" data-bs-target="#weaviate-content" type="button">
                    <i class="bi bi-diagram-3"></i> Weaviate
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent">
            <!-- S3 Tab Content -->
            <div class="tab-pane fade show active" id="s3-content" role="tabpanel" aria-labelledby="s3-tab">
                <!-- S3 Connection Panel -->
                <div class="connection-panel">
                    <h4><i class="bi bi-hdd-rack"></i> S3 Connection</h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="s3-endpoint" class="form-label">Endpoint URL</label>
                            <input type="text" class="form-control" id="s3-endpoint" placeholder="https://s3.amazonaws.com">
                        </div>
                        <div class="col-md-4">
                            <label for="s3-access-key" class="form-label">Access Key ID</label>
                            <input type="text" class="form-control" id="s3-access-key" placeholder="Your access key">
                        </div>
                        <div class="col-md-4">
                            <label for="s3-secret-key" class="form-label">Secret Access Key</label>
                            <input type="password" class="form-control" id="s3-secret-key" placeholder="Your secret key">
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary" id="s3-connect-btn">
                                <i class="bi bi-link"></i> Test Connection
                            </button>
                            <span id="s3-connection-status"></span>
                        </div>
                    </div>
                </div>

                <!-- S3 File Explorer -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-folder"></i> S3 File Explorer</h5>
                        <div>
                            <select class="form-select d-inline-block w-auto" id="s3-bucket-select">
                                <option value="" selected>Select a bucket</option>
                            </select>
                            <button class="btn btn-outline-secondary btn-sm ms-2" id="s3-refresh-btn">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Breadcrumb navigation -->
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb" id="s3-breadcrumb">
                                <li class="breadcrumb-item active">Root</li>
                            </ol>
                        </nav>

                        <!-- File list -->
                        <div class="file-explorer">
                            <div class="text-center py-5" id="s3-placeholder">
                                <i class="bi bi-hdd-rack fs-1 text-muted"></i>
                                <p class="mt-3">Select a bucket to view files</p>
                            </div>
                            <div id="s3-loader" class="text-center py-5 d-none">
                                <div class="loader"></div>
                                <p>Loading files...</p>
                            </div>
                            <table class="table table-hover d-none" id="s3-file-table">
                                <thead>
                                    <tr>
                                        <th width="50%">Name</th>
                                        <th width="20%">Size</th>
                                        <th width="30%">Last Modified</th>
                                    </tr>
                                </thead>
                                <tbody id="s3-file-list">
                                    <!-- Files will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weaviate Tab Content -->
            <div class="tab-pane fade" id="weaviate-content" role="tabpanel" aria-labelledby="weaviate-tab">
                <!-- Weaviate Connection Panel -->
                <div class="connection-panel">
                    <h4><i class="bi bi-diagram-3"></i> Weaviate Connection</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="weaviate-url" class="form-label">Weaviate URL</label>
                            <input type="text" class="form-control" id="weaviate-url" placeholder="https://weaviate-instance.com">
                        </div>
                        <div class="col-md-6">
                            <label for="weaviate-token" class="form-label">API Token (Optional)</label>
                            <input type="password" class="form-control" id="weaviate-token" placeholder="Your token">
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary" id="weaviate-connect-btn">
                                <i class="bi bi-link"></i> Test Connection
                            </button>
                            <span id="weaviate-connection-status"></span>
                        </div>
                    </div>
                </div>

                <!-- Weaviate Collection Management -->
                <div class="row">
                    <!-- Collections List -->
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Collections</h5>
                                <button class="btn btn-outline-primary btn-sm" id="refresh-collections-btn">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="weaviate-loader" class="text-center py-5 d-none">
                                    <div class="loader"></div>
                                    <p>Loading collections...</p>
                                </div>
                                <div id="weaviate-collections-placeholder" class="text-center py-5">
                                    <i class="bi bi-diagram-3 fs-1 text-muted"></i>
                                    <p class="mt-3">Connect to Weaviate to view collections</p>
                                </div>
                                <div id="weaviate-collections-list" class="d-none">
                                    <!-- Collections will be listed here -->
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-success w-100" id="create-collection-btn">
                                        <i class="bi bi-plus-circle"></i> Create New Collection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Collection Details & Objects -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><span id="collection-detail-name">Collection Details</span></h5>
                            </div>
                            <div class="card-body">
                                <div id="collection-detail-placeholder" class="text-center py-5">
                                    <i class="bi bi-info-circle fs-1 text-muted"></i>
                                    <p class="mt-3">Select a collection to view details</p>
                                </div>
                                <div id="collection-detail-content" class="d-none">
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <strong>Description:</strong>
                                                <p id="collection-description" class="mb-0">-</p>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Properties:</strong>
                                                <ul id="collection-properties"></ul>
                                            </div>
                                            <div class="d-flex">
                                                <div class="me-4">
                                                    <strong>Object Count:</strong>
                                                    <span id="collection-object-count">-</span>
                                                </div>
                                                <div>
                                                    <strong>Vector Index:</strong>
                                                    <span id="collection-vector-index">-</span>
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="d-flex justify-content-end">
                                                <button class="btn btn-danger" id="delete-collection-btn">
                                                    <i class="bi bi-trash"></i> Delete Collection
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Collection Objects Table -->
                                    <h5>Objects <button class="btn btn-sm btn-outline-secondary ms-2" id="refresh-objects-btn"><i class="bi bi-arrow-clockwise"></i></button></h5>
                                    <div id="objects-loader" class="text-center py-3 d-none">
                                        <div class="loader"></div>
                                        <p>Loading objects...</p>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover" id="collection-objects-table">
                                            <thead>
                                                <tr>
                                                    <th width="30%">ID</th>
                                                    <th width="70%">Properties</th>
                                                </tr>
                                            </thead>
                                            <tbody id="collection-objects-list">
                                                <!-- Objects will be listed here -->
                                            </tbody>
                                        </table>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                <span id="objects-pagination-info">Showing 0 objects</span>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary me-2" id="prev-objects-page" disabled>
                                                    <i class="bi bi-chevron-left"></i> Previous
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" id="next-objects-page" disabled>
                                                    Next <i class="bi bi-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Collection Modal -->
    <div class="modal fade" id="createCollectionModal" tabindex="-1" aria-labelledby="createCollectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createCollectionModalLabel">Create New Collection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-collection-form">
                        <div class="mb-3">
                            <label for="collection-name" class="form-label">Collection Name</label>
                            <input type="text" class="form-control" id="collection-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="collection-description" class="form-label">Description</label>
                            <textarea class="form-control" id="collection-description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vector Index Type</label>
                            <select class="form-select" id="vector-index-type">
                                <option value="cosine">Cosine (Default)</option>
                                <option value="dot">Dot Product</option>
                                <option value="l2-squared">L2 Squared (Euclidean)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Properties</label>
                            <div id="properties-container">
                                <!-- Initial property row -->
                                <div class="property-row d-flex mb-2">
                                    <input type="text" class="form-control me-2" placeholder="Property name">
                                    <select class="form-select me-2">
                                        <option value="text">Text</option>
                                        <option value="int">Integer</option>
                                        <option value="number">Number</option>
                                        <option value="boolean">Boolean</option>
                                        <option value="date">Date</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-danger remove-property-btn">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-property-btn">
                                <i class="bi bi-plus"></i> Add Property
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submit-create-collection">Create Collection</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Collection Confirmation Modal -->
    <div class="modal fade" id="deleteCollectionModal" tabindex="-1" aria-labelledby="deleteCollectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCollectionModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the collection <strong id="delete-collection-name"></strong>?</p>
                    <p class="text-danger">This action cannot be undone. All data in this collection will be permanently deleted.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-collection">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript and Bootstrap dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Global variables
        let currentS3Bucket = '';
        let currentS3Prefix = '';
        let currentCollection = '';
        let objectsPage = {
            offset: 0,
            limit: 20,
            totalCount: 0
        };

        // Document ready function
        $(document).ready(function() {
            // Initialize event listeners
            initS3EventListeners();
            initWeaviateEventListeners();
            initModals();
        });

        // Show a notification
        function showNotification(message, type = 'info') {
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            $('#alertContainer').append(alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $(`#${alertId}`).alert('close');
            }, 5000);
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Format object properties for display
        function formatProperties(properties) {
            if (!properties || Object.keys(properties).length === 0) {
                return '<em>No properties</em>';
            }
            
            const formatted = Object.entries(properties)
                .map(([key, value]) => {
                    // Format the value based on its type
                    let displayValue = value;
                    if (typeof value === 'object' && value !== null) {
                        displayValue = JSON.stringify(value);
                    } else if (typeof value === 'boolean') {
                        displayValue = value ? 'true' : 'false';
                    }
                    
                    // Truncate long values
                    if (typeof displayValue === 'string' && displayValue.length > 100) {
                        displayValue = displayValue.substring(0, 100) + '...';
                    }
                    
                    return `<strong>${key}:</strong> ${displayValue}`;
                })
                .join('<br>');
                
            return formatted;
        }

        // Initialize S3 event listeners
        function initS3EventListeners() {
            // Test S3 connection
            $('#s3-connect-btn').click(function() {
                const endpointUrl = $('#s3-endpoint').val();
                const accessKey = $('#s3-access-key').val();
                const secretKey = $('#s3-secret-key').val();
                
                $('#s3-connection-status').html('<div class="loader"></div> Testing connection...');
                
                $.ajax({
                    url: '/api/test-s3-connection',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        endpoint_url: endpointUrl,
                        aws_access_key_id: accessKey,
                        aws_secret_access_key: secretKey
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#s3-connection-status').html('<span class="text-success"><i class="bi bi-check-circle"></i> Connected</span>');
                            showNotification('Successfully connected to S3', 'success');
                            // Load buckets
                            loadS3Buckets();
                        } else {
                            $('#s3-connection-status').html('<span class="text-danger"><i class="bi bi-x-circle"></i> Connection failed</span>');
                            showNotification('Failed to connect to S3: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'Failed to connect to S3';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMsg = response.message || errorMsg;
                        } catch (e) {
                            console.error('Error parsing error response', e);
                        }
                        
                        $('#s3-connection-status').html('<span class="text-danger"><i class="bi bi-x-circle"></i> Connection failed</span>');
                        showNotification(errorMsg, 'danger');
                    }
                });
            });
            
            // S3 bucket selection
            $('#s3-bucket-select').change(function() {
                const bucket = $(this).val();
                if (bucket) {
                    currentS3Bucket = bucket;
                    currentS3Prefix = '';
                    updateS3Breadcrumb();
                    loadS3Objects(bucket, '');
                } else {
                    $('#s3-file-table').addClass('d-none');
                    $('#s3-placeholder').removeClass('d-none');
                }
            });
            
            // S3 refresh button
            $('#s3-refresh-btn').click(function() {
                loadS3Buckets();
                if (currentS3Bucket) {
                    loadS3Objects(currentS3Bucket, currentS3Prefix);
                }
            });
            
            // S3 file/folder click handler (delegated event)
            $('#s3-file-list').on('click', '.folder', function() {
                const prefix = $(this).data('path');
                currentS3Prefix = prefix;
                updateS3Breadcrumb();
                loadS3Objects(currentS3Bucket, prefix);
            });
        }
        
        // Update S3 breadcrumb navigation
        function updateS3Breadcrumb() {
            const $breadcrumb = $('#s3-breadcrumb');
            $breadcrumb.empty();
            
            // Add root
            $breadcrumb.append(`
                <li class="breadcrumb-item${currentS3Prefix === '' ? ' active' : ''}">
                    ${currentS3Prefix === '' ? 'Root' : '<a href="#" data-prefix="">Root</a>'}
                </li>
            `);
            
            // Add path segments
            if (currentS3Prefix) {
                const segments = currentS3Prefix.split('/');
                let currentPath = '';
                
                segments.forEach((segment, index) => {
                    if (!segment) return; // Skip empty segments
                    
                    currentPath += segment + '/';
                    const isLast = index === segments.length - 1 || (index === segments.length - 2 && !segments[segments.length - 1]);
                    
                    $breadcrumb.append(`
                        <li class="breadcrumb-item${isLast ? ' active' : ''}">
                            ${isLast ? segment : `<a href="#" data-prefix="${currentPath}">${segment}</a>`}
                        </li>
                    `);
                });
            }
            
            // Add click event for breadcrumb navigation
            $breadcrumb.find('a').click(function(e) {
                e.preventDefault();
                const prefix = $(this).data('prefix');
                currentS3Prefix = prefix;
                updateS3Breadcrumb();
                loadS3Objects(currentS3Bucket, prefix);
            });
        }
        
        // Load S3 buckets
        function loadS3Buckets() {
            $.ajax({
                url: '/api/list-s3-buckets',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const $select = $('#s3-bucket-select');
                        $select.empty();
                        $select.append('<option value="" selected>Select a bucket</option>');
                        
                        response.buckets.forEach(bucket => {
                            $select.append(`<option value="${bucket}">${bucket}</option>`);
                        });
                        
                        // Restore selection if there was one
                        if (currentS3Bucket) {
                            $select.val(currentS3Bucket);
                        }
                    } else {
                        showNotification('Failed to load S3 buckets: ' + response.message, 'danger');
                    }
                },
                error: function() {
                    showNotification('Failed to load S3 buckets', 'danger');
                }
            });
        }
        
        // Load S3 objects
        function loadS3Objects(bucket, prefix) {
            $('#s3-file-table').addClass('d-none');
            $('#s3-placeholder').addClass('d-none');
            $('#s3-loader').removeClass('d-none');
            
            $.ajax({
                url: `/api/list-s3-objects?bucket=${bucket}&prefix=${prefix}`,
                type: 'GET',
                success: function(response) {
                    $('#s3-loader').addClass('d-none');
                    
                    if (response.success) {
                        const $fileList = $('#s3-file-list');
                        $fileList.empty();
                        
                        // Add parent directory if not at root
                        if (prefix) {
                            const parts = prefix.split('/');
                            // Remove last part or last two parts if the prefix ends with /
                            const parentPrefix = prefix.endsWith('/') 
                                ? parts.slice(0, -2).join('/') + '/' 
                                : parts.slice(0, -1).join('/') + '/';
                            
                            if (parentPrefix !== prefix) {
                                $fileList.append(`
                                    <tr class="folder" data-path="${parentPrefix}">
                                        <td><i class="bi bi-arrow-up-circle me-2"></i>..</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                `);
                            }
                        }
                        
                        // Add directories
                        response.directories.forEach(dir => {
                            $fileList.append(`
                                <tr class="folder" data-path="${dir.path}">
                                    <td><i class="bi bi-folder me-2"></i>${dir.name}</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                            `);
                        });
                        
                        // Add files
                        response.files.forEach(file => {
                            $fileList.append(`
                                <tr class="file">
                                    <td><i class="bi bi-file-earmark me-2"></i>${file.name}</td>
                                    <td>${formatFileSize(file.size)}</td>
                                    <td>${file.last_modified || '-'}</td>
                                </tr>
                            `);
                        });
                        
                        // Show the table
                        $('#s3-file-table').removeClass('d-none');
                    } else {
                        $('#s3-placeholder').removeClass('d-none');
                        showNotification('Failed to load S3 objects: ' + response.message, 'danger');
                    }
                },
                error: function() {
                    $('#s3-loader').addClass('d-none');
                    $('#s3-placeholder').removeClass('d-none');
                    showNotification('Failed to load S3 objects', 'danger');
                }
            });
        }

        // Initialize Weaviate event listeners
        function initWeaviateEventListeners() {
            // Test Weaviate connection
            $('#weaviate-connect-btn').click(function() {
                const weaviateUrl = $('#weaviate-url').val();
                const weaviateToken = $('#weaviate-token').val();
                
                $('#weaviate-connection-status').html('<div class="loader"></div> Testing connection...');
                
                $.ajax({
                    url: '/api/test-weaviate-connection',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        weaviate_url: weaviateUrl,
                        weaviate_token: weaviateToken
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#weaviate-connection-status').html('<span class="text-success"><i class="bi bi-check-circle"></i> Connected</span>');
                            showNotification('Successfully connected to Weaviate', 'success');
                            // Load collections
                            loadWeaviateCollections();
                        } else {
                            $('#weaviate-connection-status').html('<span class="text-danger"><i class="bi bi-x-circle"></i> Connection failed</span>');
                            showNotification('Failed to connect to Weaviate: ' + response.message, 'danger');
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'Failed to connect to Weaviate';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMsg = response.message || errorMsg;
                        } catch (e) {
                            console.error('Error parsing error response', e);
                        }
                        
                        $('#weaviate-connection-status').html('<span class="text-danger"><i class="bi bi-x-circle"></i> Connection failed</span>');
                        showNotification(errorMsg, 'danger');
                    }
                });
            });
            
            // Refresh collections button
            $('#refresh-collections-btn').click(function() {
                loadWeaviateCollections();
            });
            
            // Collection click handler (delegated event)
            $('#weaviate-collections-list').on('click', '.weaviate-collection', function() {
                const collectionName = $(this).data('name');
                const collectionData = $(this).data('collection');
                currentCollection = collectionName;
                
                // Update collection details view
                $('#collection-detail-name').text(collectionName);
                $('#collection-description').text(collectionData.description || 'No description');
                $('#collection-object-count').text(collectionData.object_count);
                $('#collection-vector-index').text(collectionData.vector_index_type);
                
                // Update properties list
                const $propertiesList = $('#collection-properties');
                $propertiesList.empty();
                
                if (collectionData.properties && collectionData.properties.length > 0) {
                    collectionData.properties.forEach(prop => {
                        $propertiesList.append(`<li>${prop}</li>`);
                    });
                } else {
                    $propertiesList.append('<li>No properties defined</li>');
                }
                
                // Show collection details and load objects
                $('#collection-detail-placeholder').addClass('d-none');
                $('#collection-detail-content').removeClass('d-none');
                
                // Reset pagination
                objectsPage.offset = 0;
                loadCollectionObjects(collectionName);
                
                // Set delete modal data
                $('#delete-collection-name').text(collectionName);
            });
            
            // Create collection button
            $('#create-collection-btn').click(function() {
                // Show modal
                const createCollectionModal = new bootstrap.Modal(document.getElementById('createCollectionModal'));
                createCollectionModal.show();
            });
            
            // Delete collection button
            $('#delete-collection-btn').click(function() {
                if (!currentCollection) return;
                
                // Set the collection name in the modal
                $('#delete-collection-name').text(currentCollection);
                
                // Show modal
                const deleteCollectionModal = new bootstrap.Modal(document.getElementById('deleteCollectionModal'));
                deleteCollectionModal.show();
            });
            
            // Confirm delete collection
            $('#confirm-delete-collection').click(function() {
                if (!currentCollection) return;
                
                $.ajax({
                    url: '/api/delete-weaviate-collection',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        name: currentCollection
                    }),
                    success: function(response) {
                        if (response.success) {
                            showNotification(`Collection '${currentCollection}' deleted successfully`, 'success');
                            
                            // Reset current collection and refresh list
                            currentCollection = '';
                            $('#collection-detail-placeholder').removeClass('d-none');
                            $('#collection-detail-content').addClass('d-none');
                            loadWeaviateCollections();
                            
                            // Close modal
                            bootstrap.Modal.getInstance(document.getElementById('deleteCollectionModal')).hide();
                        } else {
                            showNotification('Failed to delete collection: ' + response.message, 'danger');
                        }
                    },
                    error: function() {
                        showNotification('Failed to delete collection', 'danger');
                    }
                });
            });
            
            // Submit create collection
            $('#submit-create-collection').click(function() {
                const name = $('#collection-name').val();
                const description = $('#collection-description').val();
                const vectorIndexType = $('#vector-index-type').val();
                
                if (!name) {
                    showNotification('Collection name is required', 'warning');
                    return;
                }
                
                // Gather properties
                const properties = [];
                $('.property-row').each(function() {
                    const propertyName = $(this).find('input').val();
                    const propertyType = $(this).find('select').val();
                    
                    if (propertyName) {
                        properties.push({
                            name: propertyName,
                            dataType: [propertyType]
                        });
                    }
                });
                
                // Create collection
                $.ajax({
                    url: '/api/create-weaviate-collection',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        name: name,
                        description: description,
                        properties: properties,
                        vector_index_config: {
                            distance: vectorIndexType
                        }
                    }),
                    success: function(response) {
                        if (response.success) {
                            showNotification(`Collection '${name}' created successfully`, 'success');
                            
                            // Refresh collections list
                            loadWeaviateCollections();
                            
                            // Reset form and close modal
                            resetCreateCollectionForm();
                            bootstrap.Modal.getInstance(document.getElementById('createCollectionModal')).hide();
                        } else {
                            showNotification('Failed to create collection: ' + response.message, 'danger');
                        }
                    },
                    error: function() {
                        showNotification('Failed to create collection', 'danger');
                    }
                });
            });
            
            // Refresh objects button
            $('#refresh-objects-btn').click(function() {
                if (currentCollection) {
                    loadCollectionObjects(currentCollection);
                }
            });
            
            // Pagination buttons
            $('#prev-objects-page').click(function() {
                if (objectsPage.offset >= objectsPage.limit) {
                    objectsPage.offset -= objectsPage.limit;
                    loadCollectionObjects(currentCollection);
                }
            });
            
            $('#next-objects-page').click(function() {
                if (objectsPage.offset + objectsPage.limit < objectsPage.totalCount) {
                    objectsPage.offset += objectsPage.limit;
                    loadCollectionObjects(currentCollection);
                }
            });
        }
        
        // Load Weaviate collections
        function loadWeaviateCollections() {
            $('#weaviate-collections-placeholder').addClass('d-none');
            $('#weaviate-collections-list').addClass('d-none');
            $('#weaviate-loader').removeClass('d-none');
            
            $.ajax({
                url: '/api/list-weaviate-collections',
                type: 'GET',
                success: function(response) {
                    $('#weaviate-loader').addClass('d-none');
                    
                    if (response.success) {
                        const $collectionsList = $('#weaviate-collections-list');
                        $collectionsList.empty();
                        
                        if (response.collections && response.collections.length > 0) {
                            response.collections.forEach(collection => {
                                $collectionsList.append(`
                                    <div class="weaviate-collection" data-name="${collection.name}" data-collection='${JSON.stringify(collection)}'>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${collection.name}</strong>
                                                <div class="small text-muted">${collection.object_count} objects</div>
                                            </div>
                                            <i class="bi bi-chevron-right"></i>
                                        </div>
                                    </div>
                                `);
                            });
                            
                            $collectionsList.removeClass('d-none');
                        } else {
                            $('#weaviate-collections-placeholder').removeClass('d-none');
                            $('#weaviate-collections-placeholder').html(`
                                <i class="bi bi-diagram-3 fs-1 text-muted"></i>
                                <p class="mt-3">No collections found</p>
                            `);
                        }
                    } else {
                        $('#weaviate-collections-placeholder').removeClass('d-none');
                        showNotification('Failed to load Weaviate collections: ' + response.message, 'danger');
                    }
                },
                error: function() {
                    $('#weaviate-loader').addClass('d-none');
                    $('#weaviate-collections-placeholder').removeClass('d-none');
                    showNotification('Failed to load Weaviate collections', 'danger');
                }
            });
        }
        
        // Load collection objects
        function loadCollectionObjects(collectionName) {
            $('#collection-objects-list').empty();
            $('#objects-loader').removeClass('d-none');
            
            $.ajax({
                url: `/api/list-weaviate-objects?collection=${collectionName}&limit=${objectsPage.limit}&offset=${objectsPage.offset}`,
                type: 'GET',
                success: function(response) {
                    $('#objects-loader').addClass('d-none');
                    
                    if (response.success) {
                        const $objectsList = $('#collection-objects-list');
                        $objectsList.empty();
                        
                        // Update total count
                        objectsPage.totalCount = response.total_count;
                        
                        // Update pagination info
                        const start = Math.min(objectsPage.offset + 1, objectsPage.totalCount);
                        const end = Math.min(objectsPage.offset + objectsPage.limit, objectsPage.totalCount);
                        $('#objects-pagination-info').text(`Showing ${start}-${end} of ${objectsPage.totalCount} objects`);
                        
                        // Update pagination buttons
                        $('#prev-objects-page').prop('disabled', objectsPage.offset === 0);
                        $('#next-objects-page').prop('disabled', end >= objectsPage.totalCount);
                        
                        // Add objects to table
                        if (response.objects && response.objects.length > 0) {
                            response.objects.forEach(obj => {
                                $objectsList.append(`
                                    <tr>
                                        <td class="text-break"><code>${obj.id}</code></td>
                                        <td>${formatProperties(obj.properties)}</td>
                                    </tr>
                                `);
                            });
                        } else {
                            $objectsList.append(`
                                <tr>
                                    <td colspan="2" class="text-center">No objects found</td>
                                </tr>
                            `);
                        }
                    } else {
                        showNotification('Failed to load collection objects: ' + response.message, 'danger');
                    }
                },
                error: function() {
                    $('#objects-loader').addClass('d-none');
                    showNotification('Failed to load collection objects', 'danger');
                }
            });
        }

        // Initialize modals
        function initModals() {
            // Add property button
            $('#add-property-btn').click(function() {
                const newPropertyRow = `
                    <div class="property-row d-flex mb-2">
                        <input type="text" class="form-control me-2" placeholder="Property name">
                        <select class="form-select me-2">
                            <option value="text">Text</option>
                            <option value="int">Integer</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="date">Date</option>
                        </select>
                        <button type="button" class="btn btn-outline-danger remove-property-btn">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
                $('#properties-container').append(newPropertyRow);
            });
            
            // Remove property button (delegated event)
            $('#properties-container').on('click', '.remove-property-btn', function() {
                $(this).closest('.property-row').remove();
            });
            
            // Reset form when modal is hidden
            $('#createCollectionModal').on('hidden.bs.modal', function() {
                resetCreateCollectionForm();
            });
        }
        
        // Reset create collection form
        function resetCreateCollectionForm() {
            $('#collection-name').val('');
            $('#collection-description').val('');
            $('#vector-index-type').val('cosine');
            
            // Reset properties
            $('#properties-container').empty();
            $('#properties-container').append(`
                <div class="property-row d-flex mb-2">
                    <input type="text" class="form-control me-2" placeholder="Property name">
                    <select class="form-select me-2">
                        <option value="text">Text</option>
                        <option value="int">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="date">Date</option>
                    </select>
                    <button type="button" class="btn btn-outline-danger remove-property-btn">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `);
        }
    </script>
</body>
</html> 